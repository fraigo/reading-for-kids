<!-- text-template -->
<script type="text/x-template" id="reader-component-template">
    <div class="reader-component" :orientation="orientation">
     <div class="reader-header">
         <h1></h1>
         <div @click="nextPage()" >Page {{pageNum+1}}</div>
     </div>
     <transition-group name="fade" tag="div" class="reader-content">
         <div key="image">
             <img :src="page.image" width="90%">
         </div>
        <div class="reader-toolbar" key="toolbar">
            <button @click="readWords(words, true)">Escuchar</button>
        </div>
        <div class="reader-text" key="pageNum">
            <span v-for="(word,wordIdx) in words" :key="wordIdx" @click="showWord(wordIdx)" :active="wordIdx<=currentWord" :next="wordIdx==currentWord+1">{{word}} </span>
        </div>
        <div is="popup" :info="popup" key="popup.title" ref="popup"></div>
        <div key="question" class="reader-question" v-if="status==1 && page.question">
            <div class="reader-question-title" @click="readWords(page.question.title.split(' '))" >{{ page.question.title}}</div>
            <div class="reader-question-answers">
                <div class="reader-question-answer" v-for="(answer,answerIdx) in page.question.options" :key="answerIdx">
                    <button @click="checkAnswer(answerIdx)" >{{ answer.title }}</button>
                </div>
            </div>
        </div>
        <div key="step" class="reader-question" v-if="status==2 && page.question">
            <div class="reader-question-title">Correcto!</div>
            <div class="reader-question-answers">
                <div class="reader-question-answer">
                    <button @click="nextPage()" v-if="pageNum+1<book.pages.length">Next Page</button>
                    <button @click="finish()" v-else >Finish</button>
                </div>
            </div>
        </div>
        <div key="step" class="reader-question" v-if="status==2 && !page.question">
            <div class="reader-question-answers">
                <div class="reader-question-answer">
                    <button @click="nextPage()" v-if="pageNum+1<book.pages.length">Next Page</button>
                    <button @click="finish()" v-else >Finish</button>
                </div>
            </div>
        </div>
     </transition-group>
    </div>
</script>
<script type="text/javascript">

Vue.component('reader', {
    template: '#reader-component-template',
    data: function(){
        return {
            zoom : 1,
            pageNum: 0,
            status: 0,
            currentWord: -1,
            popup: null,
            orientation: "portrait"
        }
    },
    props: { 
        book: Object
    },
    mounted:function(){
        var self = this
        this.loadWords()
    },
    methods: {
        showWord: function(idx){
            var self = this
            if (idx<=this.currentWord+1) {
                this.currentWord=idx
                this.playAudio(this.words[idx])
                var finish = this.currentWord==this.words.length-1
                if (finish) {
                    setTimeout(function(){
                        self.status = 1
                        self.$forceUpdate()
                        self.readWords(self.page.question.title.split(' '))
                    }, 1500)
                } else {
                    this.status = 0
                }
            }
        },
        playAudio: function(word, callback) {
            var audio1 = this.audioId(word)
            audioEngine.playFromStart(audio1)
            if (callback){
                var time=audioEngine.duration(audio1)
                setTimeout(function(){
                    callback()
                }, time)
            }
        },
        showAll: function(){
            var self = this
            self.currentWord=-1
            self.status=0
            var proc = setInterval(function(){
                console.log('word', self.currentWord)
                if (self.currentWord<=self.words.length-2) {
                    self.currentWord++
                    self.showWord(self.currentWord)
                } else {
                    clearInterval(proc)
                }
            }, 500)
        },
        checkAnswer: function(idx){
            var words = this.page.question.options[idx].title.split(" ")
            console.log('check',idx,this.page.question.answer,words)
            if (idx == this.page.question.answer){
                this.status = 2
                words.push('correcto')
            } else {
                this.currentWord = -1
                words.push('intenta_otra_vez')
            }
            this.readWords(words)
        },
        nextPage: function(){
            this.pageNum++
            this.currentWord = -1
            this.status = 0
            this.loadWords()
        },
        finish: function() {
            this.pageNum=-1
            this.nextPage()
        },
        audioId: function(id){
            id = id.toLowerCase()
            id = id.replaceAll('à','a')
            id = id.replaceAll('é','e')
            id = id.replaceAll('í','i')
            id = id.replaceAll('ó','o')
            id = id.replaceAll('ú','u')
            id = id.replaceAll('?','')
            id = id.replaceAll(',','')
            id = id.replaceAll('.','')
            return id
        },
        loadWords: function() {
            if (!this.book){
                return
            }
            var audios = this.words
            audios = audios.concat(this.page.question.title.split(' '))
            for (var idx in this.page.question.options){
                var answer = this.page.question.options[idx]
                audios = audios.concat(answer.title.split(' '))
            }
            audios.push("correcto")
            audios.push("intenta_otra_vez")
            for(var idx=0; idx< audios.length; idx++) {
                var audio1 = this.audioId(audios[idx])
                var base = document.location.pathname.replace("index.html","")
                audioEngine.load(base+"audio/"+this.book.lang+"/"+audio1+".wav", audio1)
            }
        },
        readWords: function (list, showWord, callback) {
            var time = 50
            var self = this
            for(var idx=0; idx< list.length; idx++) {
                var audio1 = this.audioId(list[idx])
                console.log('play', audio1)
                setTimeout(function(audio,idx){ 
                    if (showWord) {
                        self.showWord(idx)
                    } else {
                        self.playAudio(audio)
                    }
                },time,audio1,idx)
                time+=audioEngine.duration(audio1)-200
            }
            setTimeout(function(){ 
                if (callback) {
                    callback()
                }
            }, time)
        }
    },
    computed:{
        page: function(){
            return this.book.pages[this.pageNum]
        },
        words: function() {
            return this.book.pages[this.pageNum].content.split(" ")
        }
    }
});
</script>
<style>
.reader-component{
    font-size: 16px;
    line-height: 1.5em;
}
.reader-header{
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.reader-text{
    font-size: 2rem;
    color: rgb(80,80,80);
    line-height: 1.5em;
}
.reader-content{
    text-align: center;
}
.reader-text span[active="true"]{
    color: rgb(240,240,240);
    cursor: pointer;
}
.reader-text span[next="true"]{
    color: rgb(128,128,128);
    cursor: pointer;
}
.reader-toolbar button{
    cursor: pointer;
}
.reader-question{
    margin: 24px 0;
}
.reader-question-answer{
    margin: 8px;
}
.reader-question-answer button{
    cursor: pointer;
}
</style>
    